#!/usr/bin/env node
(function() {
    if (process.argv.length < 6) {
        console.log("Usage: backpack-clear <path> <data file number> <redis host> <redis port>");
        return;
    }

    var args        = process.argv,
        redis       = require("redis").createClient(args[5], args[4], { return_buffers: true }),
        FileManager = require("../index").FileManager,
        manager     = new FileManager(args[2], redis);

    function exit(error) {
        console.log(error);
        process.exit(1);
    }

    manager.isReadOnlyFile(args[3], function(error, readOnly) {
        if (error) {
            return exit(error);
        }

        if (!readOnly) {
            return exit("File #" + args[3] + " is not read only to be cleared!");
        }

        manager.getFile(args[3], function(error, file) {
            if (error) {
                return exit(error);
            }

            file.getMeta().getContents(function(error, contents) {
                if (error) {
                    return exit(error);
                }

                (function process() {
                    var element = contents.pop();

                    if (!element) {
                        redis.end();
                        console.log("===================");
                        console.log("Finished, now data and meta file could be deleted and backpack server restarted");
                        return;
                    }

                    manager.nodeKeySerializer(element[0], function(error, key) {
                        if (error) {
                            return exit(error);
                        }

                        redis.get(key, function(error, info) {
                            if (error) {
                                return exit(error);
                            }

                            if (!info) {
                                console.log("Not found info for " + element[0] + ", probably already deleted");
                                return process();
                            }

                            manager.nodeInfoUnserializer(info, function(error, info) {
                                if (error) {
                                    return exit(error);
                                }

                                if (info.file != args[3]) {
                                    console.log("Different data file for " + element[0] + " " + info.file + " vs " + args[3] + ", skipping");
                                    return process();
                                }

                                redis.del(key, function(error, deleted) {
                                    if (error) {
                                        return exit(error);
                                    }

                                    if (!deleted) {
                                        return exit(error);
                                    }

                                    process();
                                });
                            });
                        });
                    });
                })();
            });
        });
    });
})();

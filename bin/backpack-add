#!/usr/bin/env node
(function() {
    if (process.argv.length < 5) {
        console.log("Usage: backpack-add <path> <redis host> <redis port>");
        return;
    }

    var args        = process.argv,
        redis       = require("redis").createClient(args[4], args[3]),
        child       = require("child_process"),
        FileManager = require("../index").FileManager;
        manager     = new FileManager(args[2], redis),
        ddArgs      = ["if=/dev/zero", "bs=1024", "count=4000000"];

    manager.addStorageFile(function(error, id) {
        if (error) {
            console.log(error);
        }

        console.log("Registered file #" + id + ", filling file (this could take some time)");

        ddArgs.push("of=" + args[2] + "/data_" + id);
        child.spawn("dd", ddArgs).on("exit", function(code) {
            if (code != 0) {
                console.log("error");
                return;
            }

            console.log("Successfully filled file #" + id);
            redis.end();
        });

    });
})();
